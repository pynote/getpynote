const ALL_PACKAGES=new Set,ALL_FILES=new Set;(async()=>{const e=Array.from(document.querySelectorAll("pynote")),t=new FormData,n=[];e.forEach(((e,s)=>{const r=e.getAttribute("packages")??"";r.split(",").map((e=>e.trim())).filter(Boolean).forEach((e=>ALL_PACKAGES.add(e)));const o=e.getAttribute("files")??"";o.split(/[\n,;]/).map((e=>e.trim())).filter(Boolean).forEach((e=>ALL_FILES.add(e))),t.append(`notes[${s}][src]`,e.getAttribute("src")??""),t.append(`notes[${s}][packages]`,r),t.append(`notes[${s}][files]`,o),t.append(`notes[${s}][code]`,e.textContent.trim()),t.append(`notes[${s}][readonly]`,e.getAttribute("readonly")??"");const i=document.createElement("div");i.innerHTML='<div style="text-align:center;padding:10px;"><img src="pynote-load.gif" width="28" /></div>',e.replaceWith(i),n[s]=i}));try{const s=await fetch("/pynote.php",{method:"POST",body:t});if(!s.ok)throw new Error(`HTTP ${s.status}`);const{html:r}=await s.json();if(!Array.isArray(r)||r.length!==e.length)throw new Error("R√©ponse inattendue du serveur");r.forEach(((e,t)=>{const s=document.createElement("div");s.className="pynote-result",s.setAttribute("data-from","pynote"),s.innerHTML=e,n[t].replaceWith(s)})),"function"==typeof initEditors&&initEditors(),"function"==typeof initializeEditors&&initializeEditors(),await typesetMathIn(document),await highlightIn(document),document.dispatchEvent(new CustomEvent("pynote:rendered"))}catch(e){n.forEach((t=>{const n=document.createElement("div");n.className="pynote-error",n.textContent=`Erreur de chargement: ${e.message}`,t.replaceWith(n)}))}})();const s=document.createElement("style");s.textContent="\n.hljs {border-radius:4px;border:1px solid silver;}\n",document.head.appendChild(s);import ace from"https://cdn.jsdelivr.net/npm/ace-builds@1.43.4/+esm";function setRunVisible(e,t){e&&("disabled"==t&&(e.style.display="block",e.classList.add("is-disabled"),e.style.pointerEvents="none",e.style.opacity="0.5",e.setAttribute("aria-disabled","true")),"visible"==t&&(e.style.display="block",e.classList.remove("is-disabled"),e.style.pointerEvents="",e.style.opacity="",e.removeAttribute("aria-disabled")),"hidden"==t&&(e.style.display="none"))}function setRestartVisible(e,t){e&&(e.style.display=t?"":"none")}function setSpinVisible(e,t){e&&(e.style.display=t?"":"none")}ace.config.set("basePath","https://cdn.jsdelivr.net/npm/ace-builds@1.43.4/src-min-noconflict/");const editor_code=Object.create(null);function getUidFromEditorId(e){return e?.startsWith("code_editor_")?e.slice(12):e}function initEditors(){document.querySelectorAll(".code-editor").forEach((e=>{const t=getUidFromEditorId(e.id);if(editor_code[t]?.destroy)try{editor_code[t].destroy()}catch{}const n=ace.edit(e);n.setOptions({theme:"ace/theme/one_dark",mode:"ace/mode/python",maxLines:500,minLines:1,fontSize:14,wrap:!0,useWorker:!1}),n.container.style.lineHeight=1.5;const s="1"===e.dataset.readonly;n.setReadOnly(s),editor_code[t]=n}))}function initializeEditors(){document.querySelectorAll(".code-editor").forEach((e=>{const t=getUidFromEditorId(e.id),n=(document.getElementById("output_"+t),document.getElementById("run_"+t)),s=document.getElementById("restart_"+t),r=document.getElementById("spin_"+t);n&&setRunVisible(n,"hidden"),s&&setRestartVisible(s,!1),r&&setSpinVisible(r,!0)}))}function setUIFor(e,{init:t=!1,running:n=!1,completed:s=!1}){const r=document.getElementById(`run_${e}`),o=document.getElementById(`restart_${e}`);if(t){return document.querySelectorAll('[id^="spin_"]').forEach((e=>{setSpinVisible(e,!1)})),setRunVisible(r,"visible"),void setRestartVisible(o,!1)}return n?(setRunVisible(r,"hidden"),void setRestartVisible(o,!0)):s?(setRunVisible(r,"visible"),void setRestartVisible(o,!1)):void 0}function updateEditors(e,t=null){const n=Array.from(document.querySelectorAll(".code-editor")).map((e=>getUidFromEditorId(e.id)));if("init"!==e)if("completed"!==e){if("running"===e){for(const e of n)setRunVisible(document.getElementById(`run_${e}`),"disabled"),setRestartVisible(document.getElementById(`restart_${e}`),!1);null!=t&&setUIFor(t,{running:!0})}}else for(const e of n)setUIFor(e,{completed:!0});else for(const e of n)setUIFor(e,{init:!0})}function guessMime(e){return{txt:"text/plain;charset=utf-8",md:"text/markdown;charset=utf-8",csv:"text/csv;charset=utf-8",json:"application/json",pdf:"application/pdf",png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg",gif:"image/gif",webp:"image/webp",svg:"image/svg+xml",wav:"audio/wav",mp3:"audio/mpeg",ogg:"audio/ogg",mp4:"video/mp4",webm:"video/webm",py:"text/plain;charset=utf-8",html:"text/html;charset=utf-8",css:"text/plain;charset=utf-8",js:"text/plain;charset=utf-8",zip:"application/zip"}[(e.split(".").pop()||"").toLowerCase()]||"application/octet-stream"}function normalizeInlineMime(e,t){const n=(t.split(".").pop()||"").toLowerCase();return new Set(["py","js","ts","css","md","csv","tsv","log","ipynb"]).has(n)?"text/plain;charset=utf-8":"json"===n?"application/json":"svg"===n?"image/svg+xml":e||"application/octet-stream"}function canOpenInline(e,t=""){const n=(e||"").toLowerCase(),s=(t.split(".").pop()||"").toLowerCase(),r=new Set(["md","csv","tsv","log","py","js","ts","css","html","htm","svg","ipynb","json","txt"]);return[/^text\//,/^image\//,/^audio\//,/^video\//,/^application\/pdf$/,/^application\/json$/,/^application\/xml$/,/^image\/svg\+xml$/].some((e=>e.test(n)))||r.has(s)}function saveOrOpenBuffer(e,t,n){const s=normalizeInlineMime(n||guessMime(t),t),r=new Blob([e],{type:s}),o=URL.createObjectURL(r);if(canOpenInline(s,t)){const e=document.createElement("a");return e.href=o,e.target="_blank",e.rel="noopener",document.body.appendChild(e),e.click(),e.remove(),void setTimeout((()=>URL.revokeObjectURL(o)),6e4)}const i=document.createElement("a");i.href=o,i.download=t||"fichier",document.body.appendChild(i),i.click(),i.remove(),setTimeout((()=>URL.revokeObjectURL(o)),0)}function requestFileFromWorker(e,t,{timeoutMs:n=3e4}={}){return new Promise(((s,r)=>{const o="rf_"+Math.random().toString(36).slice(2);let i=null;const a=t=>{const n=t.data||{};if("fs.readFile.result"===n.type&&n.id===o){if(e.removeEventListener("message",a),i&&clearTimeout(i),n.error)return r(new Error(n.error));s({buffer:n.buffer,path:n.path,mime:n.mime})}};e.addEventListener("message",a),i=setTimeout((()=>{e.removeEventListener("message",a),r(new Error(`Timeout lecture worker pour ${t}`))}),n),e.postMessage({cmd:"readFile",id:o,path:t})}))}function setupFsDownloadDelegation(e,t){e&&t&&(e._fsDlBound||(e._fsDlBound=!0,e.addEventListener("click",(async e=>{const n=e.target.closest("a.fs-download");if(!n)return;e.preventDefault();const s=n.getAttribute("data-path"),r=s.split("/").pop()||"fichier";try{const{buffer:e,mime:n}=await requestFileFromWorker(t,s);saveOrOpenBuffer(e,r,n)}catch(e){console.error(e),alert(`Impossible de t√©l√©charger ${r} : ${e.message||e}`)}}))))}function formatBytes(e){if(null==e)return"";const t=["octets","Ko","Mo","Go","To"];let n=0,s=e;for(;s>=1024&&n<t.length-1;)s/=1024,n++;return(0===n?s:s.toFixed(1))+" "+t[n]}function renderFsListing(e){const t=document.querySelectorAll(".pyodide_fs_block");if(!t.length)return;const n=e.path||"/",s=(e.items||[]).map((e=>{if("string"==typeof e){return{name:e,path:(n.endsWith("/")?n:n+"/")+e,kind:"file",size:null}}return e}));t.forEach((t=>{const n=t.querySelector(".pyodide_fs");if(!n)return;const r=(t.getAttribute("data-files")||"").split(/[\n,;]/).map((e=>e.trim())).filter(Boolean);if(!r.length)return t.style.display="none",void(n.textContent="");if(e.error)return t.style.display="block",void(n.textContent=`Erreur FS (${e.path}) : ${e.error}`);const o=new Set(r.map((e=>e.split("/").pop()||e))),i=s.filter((e=>{const t=e.name||(e.path?e.path.split("/").pop():"");return o.has(t)}));if(!i.length)return t.style.display="none",void(n.textContent="");const a=i.slice().sort(((e,t)=>e.kind===t.kind?e.name.localeCompare(t.name):"dir"===e.kind?-1:1)).map((({name:e,path:t,kind:n,size:s})=>{if("dir"===n)return`üìÅ <span>${e}</span>`;return`<span style="vertical-align:-2px">‚ñ™ </span><a href="#" class="fs-download" data-path="${t}">${e}</a>${null!=s?` <span class="opacity-50 small" style="vertical-align:1px;">(${formatBytes(s)})</span>`:""}`})).join("\n");t.style.display="block",n.innerHTML=a,setupFsDownloadDelegation(t,pyodideWorker)}))}const workerCode="\n\nself.importScripts('https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js');\n\nvar globals_keys = [];\n\n\nvar installedPackages = new Set();\n\n\nfunction filenameFromUrl(url) {\n  try {\n    const u = new URL(url, self.location.href);\n    const base = u.pathname.split('/').pop() || 'fichier';\n    return decodeURIComponent(base);\n  } catch {\n    return (url.split('?')[0].split('/').pop() || 'fichier');\n  }\n}\n\n\nfunction ensureDir(path) {\n  const parts = path.split('/').filter(Boolean);\n  let cur = '';\n  for (const p of parts) {\n    cur += '/' + p;\n    try { self.pyodide.FS.mkdir(cur); } catch {}\n  }\n}\n\n\nasync function putUrls(urls, dir = '/home/pyodide') {\n  const results = [];\n  ensureDir(dir.replace(/\\/+$/,''));\n  for (const url of urls) {\n    const name = filenameFromUrl(url);\n    const dest = (dir.replace(/\\/+$/,'') + '/' + name).replace(/\\/+/g, '/');\n    try {\n      const res = await fetch(url, { mode: 'cors' });\n      if (!res.ok) throw new Error(`HTTP ${res.status}`);\n      const bytes = new Uint8Array(await res.arrayBuffer());\n      self.pyodide.FS.writeFile(dest, bytes);\n      results.push({ url, path: dest, ok: true, size: bytes.length });\n    } catch (e) {\n      results.push({ url, path: dest, ok: false, error: String(e?.message || e) });\n    }\n  }\n  return results;\n}\n\n\nasync function main() {\n  self.pyodide = await loadPyodide();\n  for (const key of self.pyodide.globals.keys()) {\n    globals_keys.push(key);\n  }\n  self.postMessage({ init: true });\n}\nlet pyodideReadyPromise = main();\n\n\nself.onmessage = async (event) => {\n  const data = event.data || {};\n  const code = data.code;\n  const bibliotheques = data.bibliotheques;\n  const scope = data.scope;\n  const id = data.id;\n\n  await pyodideReadyPromise;\n\n\n  if (data.cmd === 'putUrls') {\n    try {\n      const dir = data.dir || '/home/pyodide';\n      const urls = Array.isArray(data.urls) ? data.urls : [];\n      const results = await putUrls(urls, dir);\n      self.postMessage({ putUrls: { dir, results } });\n    } catch (e) {\n      self.postMessage({ putUrls: { error: String(e?.message || e) } });\n    }\n    return;\n  }\n\n\n  if (data.cmd === 'ls') {\n    try {\n      const p = data.path || '/';\n      const names = self.pyodide.FS.readdir(p).filter(n => n !== '.' && n !== '..');\n      const items = names.map((name) => {\n        const full = (p.endsWith('/') ? p : p + '/') + name;\n        let st = null;\n        try { st = self.pyodide.FS.stat(full); } catch {}\n        const isDir = st ? self.pyodide.FS.isDir(st.mode) : false;\n        const size  = (!isDir && st) ? st.size : null;\n        return { name, path: full, kind: isDir ? 'dir' : 'file', size };\n      });\n      self.postMessage({ fs: { path: p, items } });\n    } catch (err) {\n      self.postMessage({ fs: { path: data.path || '/', items: [], error: String(err && err.message ? err.message : err) }});\n    }\n    return;\n  }\n\n\n  if (data.cmd === 'readFile') {\n    try {\n      const p = data.path;\n      if (!p) throw new Error('Chemin manquant (path)');\n      const bytes = self.pyodide.FS.readFile(p, { encoding: 'binary' });\n      const buffer = bytes.buffer.slice(bytes.byteOffset, bytes.byteOffset + bytes.byteLength);\n      self.postMessage({ type: 'fs.readFile.result', id: data.id, path: p, buffer }, [buffer]);\n    } catch (err) {\n      self.postMessage({ type: 'fs.readFile.result', id: data.id, path: data.path, error: String(err && err.message ? err.message : err) });\n    }\n    return;\n  }\n\n\n  if (data.cmd === 'installPackages') {\n    try {\n      const pkgs = Array.isArray(data.packages) ? data.packages : [];\n      const toInstall = [...new Set(pkgs)]\n        .map(s => String(s || '').trim())\n        .filter(Boolean)\n        .filter(name => !installedPackages.has(name));\n\n      if (toInstall.length) {\n        await self.pyodide.loadPackage(\"micropip\");\n        const micropip = self.pyodide.pyimport(\"micropip\");\n\n        for (const name of toInstall) {\n          self.postMessage({ type: \"pip_progress\", status: \"installing\", name });\n          try {\n            await micropip.install(name);\n            installedPackages.add(name);\n            self.postMessage({ type: \"pip_progress\", status: \"ok\", name });\n          } catch (e) {\n            self.postMessage({\n              type: \"pip_progress\",\n              status: \"error\",\n              name,\n              error: String(e?.message || e)\n            });\n          }\n        }\n      } else {\n\n        self.postMessage({ type: \"pip_progress\", status: \"nothing_to_do\" });\n      }\n    } catch (e) {\n      self.postMessage({\n        type: \"pip_progress\",\n        status: \"fatal\",\n        error: String(e?.message || e)\n      });\n    }\n    return;\n  }\n\n\n  if (scope == 'cell') {\n    const clesASupprimer = [];\n    for (const key of self.pyodide.globals.keys()) {\n      if (!globals_keys.includes(key)) clesASupprimer.push(key);\n    }\n    for (const key of clesASupprimer) {\n      self.pyodide.globals.delete(key);\n    }\n  }\n\n\n  const bibs = Array.isArray(bibliotheques) ? bibliotheques\n              : String(bibliotheques || \"\").split(\",\").map(s => s.trim()).filter(Boolean);\n  const uniqueBibs = [...new Set(bibs)].sort((a,b)=>a.localeCompare(b));\n\n  try {\n    self.postMessage({ status: 'running', id });\n\n\n    self.pyodide.setStdout({ batched: (str) => {\n      self.postMessage({ output: str + \"\\n\", id });\n    }});\n\n\n    if (uniqueBibs.length) {\n      await self.pyodide.loadPackage(\"micropip\");\n      const micropip = self.pyodide.pyimport(\"micropip\");\n      for (const name of uniqueBibs) {\n        self.postMessage({ type: \"pip_progress\", status: \"installing\", name });\n        const r = await micropip.install(name)\n          .then(() => ({ ok: true }))\n          .catch(e => ({ ok: false, error: String(e?.message || e) }));\n        self.postMessage({ type: \"pip_progress\", status: r.ok ? \"ok\" : \"error\", name, error: r.error });\n      }\n    }\n\n\n    await self.pyodide.loadPackagesFromImports(code);\n    let output = self.pyodide.runPython(code);\n    if (typeof output !== 'undefined') {\n      self.postMessage({ output: String(output) + \"\\n\", id });\n    }\n\n    self.postMessage({ status: 'completed' });\n\n  } catch (err) {\n\n    let errors = err.message.split('File \"<exec>\", ');\n    let output_message = \"\";\n    errors.forEach((error) => {\n      if (typeof error !== 'undefined' && !error.includes('Traceback')) {\n        let m = /line (\\d+)/.exec(error);\n        let error_line = m ? m[1] : '?';\n        let error_string = error.replace(/^.*\\n/, '');\n        output_message += (\"Erreur ligne \" + error_line + \"\\n\" + (error_string || '')).trim() + \"\\n\\n\";\n      }\n    });\n    self.postMessage({ output: output_message.trim(), id });\n    self.postMessage({ status: 'completed' });\n  }\n};\n",workerUrl=URL.createObjectURL(new Blob([workerCode],{type:"text/javascript"}));let pyodideWorker=new Worker(workerUrl);function setupWorkerListener(e){e.onmessage=function(t){const n=t.data||{};if("pip_progress"===n.type&&("installing"===n.status?console.log("[Pyodide] Installation de",n.name):"ok"===n.status?console.log("[Pyodide] Install√© :",n.name):"error"===n.status?console.error("[Pyodide] Erreur installation",n.name,":",n.error):console.log("[Pyodide] pip_progress",n)),n.init){updateEditors("init");const t=Array.from(ALL_PACKAGES);t.length&&e.postMessage({cmd:"installPackages",packages:t});const n=Array.from(ALL_FILES);return n.length&&e.postMessage({cmd:"putUrls",urls:n,dir:"/home/pyodide"}),void e.postMessage({cmd:"ls",path:"/home/pyodide"})}if(n.putUrls)return n.putUrls.error&&console.error("putUrls error:",n.putUrls.error),void e.postMessage({cmd:"ls",path:n.putUrls.dir||"/home/pyodide"});if(n.fs)renderFsListing(n.fs);else{if(n.status)return"running"===n.status&&null!=n.id&&updateEditors("running",n.id),void("completed"===n.status&&(updateEditors("completed"),setTimeout((()=>{e.postMessage({cmd:"ls",path:"/home/pyodide"})}),0)));if("output"in n&&null!=n.id){const e=document.getElementById("output_"+n.id);e&&(e.innerHTML+=n.output)}}}}setupWorkerListener(pyodideWorker);const scope="session";function run(e){const t=editor_code[e];if(!t)return void console.warn("√âditeur introuvable pour",e);const n=t.getValue(),s=document.querySelector(`#output_${e}`);s&&(s.textContent=""),updateEditors("running",e),pyodideWorker.postMessage({code:n,id:e,scope:scope,bibliotheques:[]})}function restart(e){pyodideWorker&&(pyodideWorker.terminate(),console.log("Web Worker supprim√©."));try{pyodideWorker=new Worker(workerUrl),console.log("Web Worker red√©marr√©.");document.querySelectorAll('[id^="output_"]').forEach((e=>{}));document.querySelectorAll('[id^="spin_"]').forEach((e=>{setSpinVisible(e,!0)}));document.querySelectorAll('[id^="restart_"]').forEach((e=>{setRestartVisible(e,!1)}));document.querySelectorAll('[id^="run_"]').forEach((e=>{setRunVisible(e,"hidden")})),setupWorkerListener(pyodideWorker)}catch(t){console.error("√âchec red√©marrage worker:",t);const n=document.querySelector(`#output_${e}`);return void(n&&(n.textContent+=`\n[Erreur red√©marrage] ${t}\n`))}}window.restart=function(){const e=document.activeElement,t=e?.closest?.('div[id^="restart_"]');if(!t)return;restart(t.id.slice(8))},document.addEventListener("click",(e=>{const t=e.target.closest('div[id^="run_"]');if(t){return void run(t.id.slice(4))}const n=e.target.closest('div[id^="restart_"]');if(n){restart(n.id.slice(8))}}));let mathJaxReadyPromise=null;function ensureMathJax(){return mathJaxReadyPromise||(window.MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"]]},svg:{fontCache:"global"}},mathJaxReadyPromise=import("https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-svg.js")),mathJaxReadyPromise}async function typesetMathIn(e=document){if(await ensureMathJax(),window.MathJax?.typesetPromise){const t=Array.from(e.querySelectorAll("div.pynote_text"));if(!t.length)return;try{await window.MathJax.typesetPromise(t)}catch(e){console.log("Erreur de rendu MathJax : ",e)}}}const DEFAULT_HLJS_CSS="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.11.1/build/styles/atom-one-light.min.css";function ensureHighlightCss(e=DEFAULT_HLJS_CSS){if(document.querySelector('link[data-pynote-hljs], link[data-hljs-theme], link[href*="highlight.js"], link[href*="highlightjs"]'))return;const t=document.createElement("link");t.rel="stylesheet",t.href=e,t.setAttribute("data-pynote-hljs","1"),document.head.appendChild(t)}let hljsReadyPromise=null;function ensureHighlightJs(){return window.hljs?Promise.resolve(window.hljs):(hljsReadyPromise||(hljsReadyPromise=new Promise(((e,t)=>{const n=document.createElement("script");n.src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.11.1/build/highlight.min.js",n.async=!0,n.onload=()=>e(window.hljs),n.onerror=()=>t(new Error("√âchec de chargement de highlight.js")),document.head.appendChild(n)}))),hljsReadyPromise)}async function highlightIn(e=document){try{ensureHighlightCss();const t=await ensureHighlightJs();if(!t)return;e.querySelectorAll("pre code").forEach((e=>{t.highlightElement(e)}))}catch(e){console.error("Erreur highlight.js :",e)}}initEditors(),updateEditors("init");
